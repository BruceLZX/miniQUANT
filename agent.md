（注：整体形态属于“模块化量化交易系统 + 多智能体审议工作流”的组合，行业系统架构常见分层与风险/执行/回放模块也基本按这类结构来搭。([Michael Brenndoerfer][1]) 多智能体“辩论/批评者/裁决者”是常见模式。([DEV Community][2])）

---
## 0) 项目介绍以及基本功能

### 0.1 项目介绍
这是一个量化+agent的ai投资公司交易平台，允许用户根据平台的推荐，或者自己选择股票，然后交给股票平台进行炒股。

### 0.2 基本功能
用户可以选择多只股票，选择后交与平台，平台自动分析并进行交易。用户可以监控建议记录，股票现状的寻常交易平台有的信息。
此外，用户可以选择模型，调整api，对ai分析频率，次数等基本参数进行调节。
平台应该允许用户输入自己的股票帐号。在没有用户提供股票帐号的情况下，平台应该提供模拟账号，进行模拟交易。
用户应当可以监测每只股票ai的分析过程和结果。然后在主界面有一个地方会把每只股票交易内容展现出来，方便用户无法输入股票账户的情况下手动进行交易。



### 0.3 交易规则：
每天每只股票只能交易两次，每周每只股票只能选择两天进行交易。
每个股票都有独立的D2，3，4，D6部门。所有股票都共享D1和D5部门。D7部门独立于所有部门。

## 0.4 环境：
前端：Vue
后端：python



## 1) 系统定位与核心原则

### 1.1 系统定位

* 这是一个**研究—决策—执行闭环**的“AI 投资公司”系统：

  * 研究部（宏观/行业/单股/专家材料）产出**结构化观点**（带证据与可证伪条件）
  * 量化部持续跑：把市场数据 + 研究输出数值化后融合成**仓位建议**
  * 投委会（决策部门）按稳健风格做**最终交易裁决**（可 NO TRADE）
  * 交易执行先走 **paper trading**，全链路日志 + 事后评分更新权重

### 1.2 核心原则（必须写进系统规范）

1. **时间一致性**：任何输出只能使用“当时已知”的数据（全部证据带时间戳）
2. **可审计**：每个结论都能追溯到证据（source_id + 摘要/短引）
3. **稳健优先**：分歧大/事件风险高时，默认降仓或不交易
4. **记忆外置 + 权限隔离**：模型本身不“记忆”，记忆统一在 Memory Store，按部门/角色授权读取，防串线

---

## 2) 组织结构（Departments & Roles）

### 2.1 部门

* **D1 宏观国际新闻部**：政治/央行/地缘/宏观金融
* **D2 行业部**：产业方向（软件/AI/矿业/贵金属…）
* **D3 单股新闻部**：公司层面新闻/财报/监管/诉讼/产品/管理层
* **D4 专业材料部**：用户上传/爬虫抓到的专家分析与图片摘要。
* **D5 量化部**：市场微结构 + 大额资金流 + 融合研究因子，持续更新
* **D6 投资决策委员会（IC）**：综合 D1–D5，做最终交易决策
* **D7 选股部**：每天一次输出候选池（供后续逐个进入 D1–D6）

### 2.2 人员编制（除 D5 外）

每个研究类部门（D1/D2/D3/D4/D6/D7）都固定：

* 3× 分析者（Analyst A/B/C）
* 1× 批评者（Critic）
* 1× 拍板者（Decider）

每个“员工”可用 kimi / chatgpt / glm5 之一，其中三个分析者必定分别使用三个不同的模型。（或做 ensemble），但**这是实现层选择**，设计层只要求：同一角色可多模型冗余以提高鲁棒性。其他角色可以由deepseek来完成。

---

## 3) 运行节奏（频率与成本控制）

要求：D5 一直跑，其余 30–600 分钟，用户可以在前端自定义，D6 可略频繁但别太贵，D7 每天一次。

### 3.1 基础调度频率

* **D5（量化）**：持续运行（建议 1–5 分钟一个更新周期）
* **D1（宏观）**：每 60 分钟
* **D2（行业）**：每 60 分钟
* **D3（单股）**：每 60 分钟
* **D4（专家材料）**：事件驱动（新材料到达触发），否则每 6 小时轻量重评
* **D6（IC）**：每 30 分钟（并支持事件触发，见下）
* **D7（选股）**：每天一次（盘前或固定时间）

### 3.2 事件触发（只在“值得花钱”时额外跑）

触发 D6（或加速 D3）的一般条件：

* 大额资金流指标突变（见 WF 定义）
* 波动率/点差异常升高（风险事件）
* 单股重大新闻出现（先规则筛，再让 D3 确认）

并加“冷却时间”：

* 同一股票，事件触发 D6 至少间隔 15 分钟，防止高频刷爆成本

---

## 4) 数据与证据（Evidence）统一标准

### 4.1 证据包（Evidence Pack）的概念

任何部门的分析只能基于“本次证据包” + “允许读取的记忆摘要”。证据包包含：

* 内容条目（新闻/公告/材料/市场片段）
* 时间戳
* 来源可靠性评分（rule-based 即可）
* 唯一 source_id（URL 或文件 hash）

### 4.2 统一输出必须“证据绑定”

每条关键论点都必须附带至少 1 条证据（source_id + 时间 + 短摘），这样整个系统才可审计与可回放。

---

## 5) 三轮讨论机制（你的核心逻辑）

每个部门每次运行固定 3 轮，产出一个部门最终结论（DeptFinal）。

### Round 1：独立分析

* 三个分析者各自独立输出：

  * stance（bull/bear/neutral）
  * 分数 score ∈ [-1, 1]（方向+强度）
  * 置信度 confidence ∈ [0, 1]
  * 关键证据与反证
  * 可证伪条件（出现什么就推翻）

### Round 2：批评质疑

* 批评者读取 Round1 的摘要结果，输出：

  * 逻辑漏洞/证据不足点
  * 最强反方论证（steelman）
  * 风险情景（tail risk）
  * 对“置信度”的校正建议（谁过度自信/谁依据不足）

### Round 3：拍板裁决

* 拍板者必须做：

  * 列出共识点/分歧点
  * 给出最终 score、confidence、thesis
  * 给出“可证伪触发条件”清单
  * 给出行动建议（加仓/减仓/观望/不交易）

> 这一机制是你系统稳定性的关键：它把“多模型、多角度”转成“可治理的结构化结论”。多智能体批评/裁决属于常见高可靠 pattern。([DEV Community][2])

---

## 6) 记忆系统（长期/短期/会话）与不串线

### 6.1 三层记忆

**长期记忆 LTM（months/years）**

* 宏观政策框架：各国政策倾向、关键人物立场、监管风格
* 行业结构与周期规律：产业链、供需变量、历史规律
* 公司档案：商业模式、历史风险点、管理层风格
* 你的交易制度：稳健风格、风险限额、禁交易条件

**短期记忆 STM（days/weeks）**

* 最近 7/30 天事件链（宏观/行业/公司）
* 待验证假设、未解决矛盾点
* 当前主题跟踪（例如“制裁升级风险仍在发酵”）

**会话记忆 Ephemeral（minutes/hours）**

* 仅服务本轮 3-round 讨论
* 结束后只把“纪要摘要”写入 STM（不直接进 LTM）

### 6.2 不串线的设计原则（关键）

* **模型调用不继承对话历史**（模型本体不承担记忆）
* **所有记忆外置在 Memory Store**（按 scope 管理）
* **每个部门/角色只能读取自己权限范围内的记忆摘要**
* **上下文拼装只给“摘要+证据”，不把旧输出整段反复喂回去**（避免隐性状态通道造成不可控黑盒）

> 这类“外置记忆 + 严格上下文构建”的做法，是把多智能体系统做成“可控工作流”的关键。([Decoding AI][3])

---

## 7) 量化部门 D5：最终融合模型（含公式）

你要的是：LLM 分析当作 variable 放进量化模型，同时稳健风格。定稿如下：

### 7.1 输入变量

以时间桶 (t)（例如 5min）为单位：

**(A) 市场/微结构特征**

* ( r_t = \ln(P_t/P_{t-1}) )
* ( vol_t )：短窗 realized volatility
* ( z_{vwap,t} = (P_t - VWAP_t)/\sigma(P) )
* ( imb_t = \frac{BidSize - AskSize}{BidSize + AskSize} )（可得则用）

**(B) 大额资金流（Whale Flow）**

* ( BF_t = \frac{\text{BlockNetBuyValue}_t}{ADV} )
* ( DP_t = \frac{\text{DarkPoolNet}_t}{ADV} )（可得则用）
* ( OF_t = \frac{\text{OptionsWhaleNotional}_t}{ADV} )

组合：
[
WF_t = w_1 BF_t + w_2 DP_t + w_3 OF_t
]

**(C) 研究部门数值化输出（来自拍板者的 DeptFinal）**

* 宏观：(M_t\in[-1,1],;c^M_t\in[0,1])
* 行业：(I_t,;c^I_t)
* 单股：(S_t,;c^S_t)
* 专家：(E_t,;c^E_t)

合成“研究因子”：
[
LA_t = \frac{\alpha_M c^M_t M_t + \alpha_I c^I_t I_t + \alpha_S c^S_t S_t + \alpha_E c^E_t E_t}{\alpha_M c^M_t+\alpha_I c^I_t+\alpha_S c^S_t+\alpha_E c^E_t + \epsilon}
]

分歧度（稳健核心）：
[
Dis_t = std({M_t, I_t, S_t, E_t})
]

分歧惩罚后：
[
LA'_t = LA_t \cdot (1 - \lambda Dis_t)
]

### 7.2 稳健版“门控融合”（推荐定稿）

**市场 alpha（不依赖 LLM）**：
[
A^{mkt}*t = \beta_0 + \beta_1 r_t + \beta_2 z*{vwap,t} + \beta_3 imb_t + \beta_4 WF_t
]

**研究门控（LLM 主要用于：放大/缩小/禁用）**：
[
gate_t = \sigma(\gamma_0 + \gamma_1 LA'_t - \gamma_2 Dis_t - \gamma_3 EventRisk_t)
]

最终 alpha：
[
A_t = gate_t \cdot A^{mkt}_t
]

仓位（风险缩放）：
[
pos_t = clip\Big(K \cdot \frac{A_t}{\hat{\sigma}*t},; -pos*{max},; pos_{max}\Big)
]

> 解释一句：LLM/研究输出不直接“预测价格”，而是做**环境与置信门控**。这最符合你“稳健为主、可接受有限风险”的风格，也能显著减少幻觉导致的硬亏损。

---

## 8) 决策委员会 D6：最终裁决与稳健风控

D6 仍走三轮讨论，但它的输出必须是“可执行决策”：

* Direction：LONG / SHORT / FLAT
* Target Position：目标仓位
* Execution Plan：分批/限价/失效时间
* Risk Controls：止损止盈、最大日亏损、最大回撤、禁交易条件
* Rationale：引用 D1–D5 的关键证据与反证，解释“为什么不是反方”

### 8.1 硬风控（任何触发都可以 NO TRADE）

稳健风格下，必须允许 D6 在以下情况下 **强制 FLAT / 禁止新开仓**：

* 重大事件风险高（EventRisk 高）且信息矛盾/分歧大
* 分歧度 (Dis_t) 超阈值（系统内部意见不一致）
* 流动性差/点差大（执行风险高）
* 触发日内最大亏损或最大回撤（paper 也要按真盘标准执行）

这类“风险门控 + 记录可审计动作”的结构是系统交易架构常见要求。([Michael Brenndoerfer][1])

---

## 9) D7 选股部门（每日一次）

D7 输出：候选股票池（Top-K）及其结构化评分：

* 宏观匹配度、行业顺风度、新闻动能、大额资金流热度、风险分
* 为什么现在值得进入研究流水线（why now）
* 直接剔除条件（disqualifiers）

然后系统将候选池依次创建“单股 case”，进入 D1–D6 全流程。

---

## 10) 交易执行（Paper Trading）与回放评估闭环

### 10.1 Paper Trading 的系统职责（设计层面）

* 接收 D6 的交易决策与 D5 的仓位建议
* 模拟成交、滑点、手续费、订单生命周期
* 记录每一次“决策→执行→结果”的完整链路

### 10.2 回放与评估（让系统越跑越稳）

每个 case 都要留下：

* 当时证据包、当时记忆摘要（可回放）
* D1–D6 每一轮输出的结构化记录
* D5 当时的特征、alpha、仓位
* 最终交易与模拟成交
* 事后评估：命中率、收益、回撤、置信度是否校准、哪些部门贡献了价值

并把评估结果写回：

* STM：近期策略表现与风险提示
* LTM：只有反复验证稳定的结构性结论才沉淀

这是量化系统工程化里“后验分析/风控改进”的核心模块。([QuantInsti Quantitative Learning Pvt Ltd][4])

---

## 11) 系统最终产出（你这个项目的“公司级输出”）

对每个股票、每次决策周期，你会得到一套固定“公司文档包”：

1. D1–D4：四个研究部门的最终结论（结构化、带证据、可证伪）
2. D5：持续更新的量化建议（alpha/仓位/风险）
3. D6：最终交易决策（可能 NO TRADE）+ 风控参数 + 理由
4. Paper execution 结果 + 全链路日志
5. Eval report（事后评分，用于稳健迭代）

最后，系统根据D6的决策进行交易。


